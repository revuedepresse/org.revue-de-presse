<template>
  <div class="calendar-month">
    <div
      class="calendar-month__buttons"
      :style="pickItemIcon"
    >
      <div class="calendar-month__container">
        <button
          class="calendar-month__button"
          v-text="monthYearLabel"
        />
      </div>
      <div class="calendar-month__navigation">
        <button
          :class="getPreviousItemClasses()"
          :style="previousItemIcon"
        />
        <button
          :class="getNextItemClasses()"
          :style="nextItemIcon"
        />
      </div>
    </div>
    <table class="calendar-month__days">
      <thead class="calendar-month__day-names">
        <tr class="calendar-month__day-row">
          <th
            v-for="(day, dayIndex) in days"
            :key="dayIndex"
            class="calendar-month__day-col"
          >
            <span
              class="calendar-month__day-name"
              v-text="day"
            />
          </th>
        </tr>
      </thead>
      <tbody class="calendar-month__day-numbers">
        <tr
          v-for="(rowNumber, rowIndex) in dayRows()"
          :key="rowIndex"
          class="calendar-month__day-row"
        >
          <td
            v-for="(weekDay, dayPos) in dayNumbers(rowNumber)"
            :key="dayPos"
            :class="weekDayClasses(weekDay)"
          >
            <a
              class="calendar-month__day-cell"
              @click="pickDate(weekDay)"
              v-text="weekDay.getDate()"
            />
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</template>

<script lang="ts">
import Vue from 'vue'
import { Component, Mixins } from 'vue-mixin-decorator'
import DateMixin from '../../mixins/date'
import pickItemIcon from '~/assets/icons/icon-pick-item.svg'
import previousItemIcon from '~/assets/icons/icon-previous-item.png'
import nextItemIcon from '~/assets/icons/icon-next-item.png'

const Props = Vue.extend({
  props: {
    isNextItemAvailable: {
      type: Boolean,
      default: false
    },
    isPreviousItemAvailable: {
      type: Boolean,
      default: false
    },
    month: {
      type: Number,
      required: true
    },
    year: {
      type: Number,
      required: true
    }
  }
})

interface CalendarMonthInterface extends DateMixin, Props {}

@Component
class CalendarMonth extends Mixins<CalendarMonthInterface>(DateMixin, Props) {
  data () {
    return {
      days: ['Lun.', 'Mar.', 'Mer.', 'Jeu.', 'Ven.', 'Sam.', 'Dim.']
    }
  }

  get previousItemIcon () {
    const widthOrHeight = '32px'

    return `
      --icon-previous-item-background: center / ${widthOrHeight} no-repeat url("${previousItemIcon}");
      --icon-previous-item-height: ${widthOrHeight};
      --icon-previous-item-width: ${widthOrHeight}
    `
  }

  get nextItemIcon () {
    const widthOrHeight = '32px'

    return `
      --icon-next-item-background: center / ${widthOrHeight} no-repeat url("${nextItemIcon}");
      --icon-next-item-height: ${widthOrHeight};
      --icon-next-item-width: ${widthOrHeight}
    `
  }

  get monthYearLabel () {
    return `${this.getMonths[this.month]} ${this.year}`
  }

  get pickItemIcon () {
    const widthOrHeight = '20px'

    return `
      --icon-pick-item-background: center / ${widthOrHeight} no-repeat url("${pickItemIcon}");
      --icon-pick-item-height: ${widthOrHeight};
      --icon-pick-item-width: ${widthOrHeight}
    `
  }

  dateOfFirstVisibleDay () {
    let firstVisibleDayCandidate = this.nameOfFirstDayOfMonth()

    const dateCandidate = new Date(this.year, this.month, 1)

    this.guardAgainstMissingMonthOrYear(firstVisibleDayCandidate)

    while (firstVisibleDayCandidate !== 'Lun.') {
      dateCandidate.setDate(dateCandidate.getDate() - 1)
      firstVisibleDayCandidate = this.whichDayOfWeek(dateCandidate.getDay())
    }

    return dateCandidate
  }

  dateOfLastVisibleDay () {
    let lastVisibleDayCandidate = this.nameOfLastDayOfMonth()
    const dateCandidate = new Date(this.year, this.month, this.totalDaysInMonth())

    this.guardAgainstMissingMonthOrYear(lastVisibleDayCandidate)

    while (lastVisibleDayCandidate !== 'Dim.') {
      dateCandidate.setDate(dateCandidate.getDate() + 1)
      lastVisibleDayCandidate = this.whichDayOfWeek(dateCandidate.getDay())
    }

    return dateCandidate
  }

  dayNumbers (rowNumber) {
    const shift = (rowNumber - 1) * 7

    const week = (new Array(7))
      .fill('', 0, 7)
      .map((_, index) => {
        const dayOfWeek = new Date(this.dateOfFirstVisibleDay().getTime())
        dayOfWeek.setDate(dayOfWeek.getDate() + index + shift)
        return dayOfWeek
      })

    return week
  }

  nameOfFirstDayOfMonth () {
    return this.daysOfWeek[new Date(this.year, this.month, 1).getDay()]
  }

  nameOfLastDayOfMonth () {
    const lastDayNumberOfMonth = this.totalDaysInMonth()

    return this.whichDayOfWeek(new Date(this.year, this.month, lastDayNumberOfMonth).getDay())
  }

  totalDaysInMonth (): number {
    return new Date(this.year, this.month + 1, 0).getDate()
  }

  totalDaysInPreviousMonth (): number {
    return new Date(this.year, this.month, 0).getDate()
  }

  dayRows () {
    let dateOfFirstVisibleDay

    try {
      dateOfFirstVisibleDay = this.dateOfFirstVisibleDay()
    } catch (e) {
      return
    }

    let daysBeforeSelectedMonth = 0
    if (dateOfFirstVisibleDay.getMonth() !== this.month) {
      daysBeforeSelectedMonth = this.totalDaysInPreviousMonth() - dateOfFirstVisibleDay.getDate() + 1
    }

    let dateOfLastVisibleDay

    try {
      dateOfLastVisibleDay = this.dateOfLastVisibleDay()
    } catch (e) {
      return
    }

    let daysAfterSelectedMonth = 0
    if (dateOfLastVisibleDay.getMonth() !== this.month) {
      daysAfterSelectedMonth = dateOfLastVisibleDay.getDate()
    }

    return (
      daysBeforeSelectedMonth +
      this.totalDaysInMonth() +
      daysAfterSelectedMonth
    ) / 7
  }

  getNextItemClasses () {
    return {
      'calendar-month__next-item': true,
      'calendar-month__next-item--disabled': !this.isNextItemAvailable
    }
  }

  getPreviousItemClasses () {
    return {
      'calendar-month__previous-item': true,
      'calendar-month__previous-item--disabled': !this.isPreviousItemAvailable
    }
  }

  pickDate (date) {
    const startDate = `${date.getFullYear()}-${date.getMonth()}-${date.getDay()}`
    const endDate = startDate

    this.$router.push({
      name: 'highlights',
      params: { startDate, endDate }
    })
  }

  weekDayClasses (weekDay) {
    const defaultClass = 'calendar-month__day-number'

    if (!(weekDay instanceof Date)) {
      return {
        [defaultClass]: true
      }
    }

    return {
      [defaultClass]: true,
      'calendar-month__day-number--other-month': weekDay.getMonth() !== this.month
    }
  }
}

export default CalendarMonth
</script>

<style lang="scss" scoped>
@import './calendar-month.scss';
</style>
